---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readxl)
library(tidyverse)
```

```{r}
rec <- read_excel("dados/Sankey Receitas por Fonte.xlsx", skip = 10)
des <- read_excel("dados/Sankey Despesas por Fonte.xlsx", skip = 10)

names(rec) <- c("nr", "fte", "fte_nome", "rec")
names(des) <- c("fte", "fte_nome", "nd", "des")

rec <- rec %>%
  group_by(nr) %>%
  mutate(rec = rec/1000000,
         per_rec_fte = rec/sum(rec))

des <- des %>%
  group_by(fte) %>%
  mutate(des = des/1000000,
         per_fte_des = des/sum(des))

matriz <- rec %>%
  full_join(des)

matriz <- matriz %>% 
  mutate(p = per_rec_fte * per_fte_des,
         ramo = round(rec * p,0)) %>%
  group_by(nr,nd) %>%
  summarise(p = sum(p),
            ramo = sum(ramo)) %>%
  select(nr,nd,p,ramo)
```


```{r}
library(plotly)

p <- plot_ly(
    type = "sankey",
    orientation = "h",

    node = list(
      #label = c("A1", "A2", "B1", "B2", "C1", "C2"),
      #color = c("blue", "blue", "blue", "blue", "blue", "blue"),
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

    link = list(
      source = c(0,1,0,2,3,3),
      target = c(2,3,3,4,4,5),
      value =  c(8,4,2,8,4,2)
    )
  ) %>% 
  layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

p
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
