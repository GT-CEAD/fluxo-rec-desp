---
title: "Como são aplicadas as receitas federais?"
output:
  html_document:
    theme: "cosmo"
    df_print: paged
    toc: false
    code_folding: hide
---

```{r message=FALSE, warning=FALSE}
library(readxl)
library(tidyverse)
```

```{css, echo=FALSE}

h1,h2,h3,h4 {
  color: #004a93;
}

h2 {
  font-weight: bold;
}

.destaques {
  padding: 1%;
  background-color: #eae6af;
}

.destaques ul {
  color: #004a93;
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.destaques a {
  color: inherit;
  text-decoration: none;
}

.destaques p {
  padding: 1%;
}

.destaques p:hover{
  color: #eae6af;
  background-color: #004a93;
}

```

## Metodologia

As receitas arrecadadas são destinadas a fontes de recursos, e foram agrupadas segundo uma classificação.

As despesas foram agrupadas conforme a classificação adotada no capítulo "Estrutura do Gasto Público no Brasil: evolução histórica e desafios".

## a fazer

Poderia criar vetores de cores na própria matriz, de maneira q, sempre q um nó fosse relacionado a dívida ou previdência (tanto receita, quanto despesa), usaria mesma cor. <- já fiz

fazer versão sem dívida, só deixando o pedaço da dívida q interage com o resto. só precisaria junta amortizacao com juros remover o link emissões-amortiz/juros.

descrever os critérios

juntar algumas receitas: 

recebimentos... + juros
explor + serviõs + taxas > outras
contr econ > contrib soc (exceto rgps)
remover linhas < 1bi
usar anti_join

cores muito escuras ainda...

```{r message=FALSE, warning=FALSE}
rec <- read_excel("dados/Sankey Receitas por Fonte.xlsx", skip = 10)
des <- read_excel("dados/Sankey Despesas por Fonte.xlsx", skip = 10)

names(rec) <- c("nr", "fte", "fte_nome", "rec")
names(des) <- c("fte", "fte_nome", "nd", "des")

rec <- rec %>%
  group_by(nr) %>%
  mutate(rec = rec,  #/1000000
         subtot_rec = sum(rec),
         per_rec_fte = rec/sum(rec)) # calcula os % de distrib. de cada rec nas ftes

des <- des %>%
  group_by(fte) %>%
  mutate(des = des, #/1000000
         per_fte_des = des/sum(des)) # calcula os % de distrib. de fte nas desps

matriz <- rec %>%
  full_join(des)

# calcula o % de dist. de cada rec nas desps
# calcula então o tamanho de cada link, partir do subtotal de cada receita. ignorando se for menor que um bilhao
### a fazer: remover as linhas com um anti_join, para não contaminar a informação do hoover (outgoing, ingoing count)

matriz <- matriz %>% 
  mutate(p = per_rec_fte * per_fte_des, 
         ramo = ifelse(
           (round(subtot_rec * p,0)<1000000000),
           0,
           round(subtot_rec * p,0))) %>% 
  group_by(nr,nd) %>%                        
  summarise(p = sum(p),
            ramo = sum(ramo)) %>%
  select(nr,nd,p,ramo)

# relacao unica dos rotulos de receita e despesa:
rotulos <- c(unique(matriz$nr),unique(matriz$nd))

# conta os nós e gera sequencia numerica a partir de zero
num_nos <- length(rotulos)
nos <- 0:(num_nos-1)

# cria tabelinha para numerar os nos
tab_aux <- data.frame(rotulos, nos)

# incorpora os números dos nodes na matriz, para a receita... e para a despesa.
matriz <- matriz %>%
  left_join(tab_aux, by = c("nr" = "rotulos")) %>%   
  left_join(tab_aux, by = c("nd" = "rotulos"), suffix = c("_rec","_desp"))
  
```

```{r cores-e-fontes, message=FALSE, warning=FALSE}
library(RColorBrewer)
#library(extrafont)
#font_import()
#loadfonts(device = "win")
#display.brewer.all()

# DEFINIÇÕES DAS CORES
azul_STN <- "#004a93"
amarelo_STN <- "#ffd500"
amarelo_transluc <- "rgba(255,213,0,0.6)"
verde_STN <- "#329c32"
cor_divida <- "#dd3127"
cor_divida_transluc <- "rgba(221, 49, 39,0.7)"
cor_divida_transluc2 <- "rgba(221, 49, 39,0.55)"
cor_RGPS <- azul_STN
cor_RGPS_transluc <- "rgba(0,75,147,0.7)"
cor_RGPS_transluc2 <- "rgba(0,75,147,0.55)"
### obs: se o alpha for muito baixo, o hover sobre o ramo/link fica imperceptível!

# CONSTRUÇÃO DO VETOR DE CORES DOS NOS
num_nos_rec <- length(unique(matriz$nr))
num_nos_des <- length(unique(matriz$nd))

cores_nos <- 1:num_nos
cores_nos[1:num_nos_rec] <- amarelo_STN
cores_nos[(num_nos_rec+1):(num_nos_rec+num_nos_des)] <- verde_STN

# destacar dívida

posicoes_divida <- c(
  which(unique(matriz$nr)=="Emissões de títulos"),    # esses rotulos poderiam estar parametrizados
  num_nos_rec+which(unique(matriz$nd)=="Amortização da Dívida"),
  num_nos_rec+which(unique(matriz$nd)=="Juros"))

cores_nos[posicoes_divida] <- cor_divida

# destacar previdência

posicoes_previdencia <- c(
  which(unique(matriz$nr)=="Contribuições e outras receitas do RGPS"),
  num_nos_rec+which(unique(matriz$nd)=="Benefícios Previdenciários RGPS"))

cores_nos[posicoes_previdencia] <- cor_RGPS
  
matriz$cores_ramos <- amarelo_transluc

for (i in 1:nrow(matriz)){
  if (matriz$nr[i] == "Emissões de títulos"){
    matriz$cores_ramos[i] <- cor_divida_transluc
  }
  else if (matriz$nr[i] == "Contribuições e outras receitas do RGPS"){
    matriz$cores_ramos[i] <- cor_RGPS_transluc
  }
# acrescentando condições  
  else if (matriz$nd[i] == "Amortização da Dívida" | matriz$nd[i] == "Juros"){
    matriz$cores_ramos[i] <- cor_divida_transluc2
  }
  
  else if (matriz$nd[i] == "Benefícios Previdenciários RGPS"){
    matriz$cores_ramos[i] <- cor_RGPS_transluc2
  }
}

```


```{r message=FALSE, warning=FALSE}
library(plotly)

p <- plot_ly(
    type = "sankey",
    orientation = "h",
    opacity = 0.2,

    textfont = list(
      family = "Roboto Condensed Light, Source Sans Pro, Arial Narrow",
      color = "black"
    ),

    node = list(
      label = rotulos,
      color = cores_nos,
      pad = 10,
      thickness = 25,
      line = list(
        color = "",
        width = 0
      )
    ),
    
    hoverlabel = list(
       font = list(
         family = "Roboto Condensed Light, Source Sans Pro, Arial Narrow"
       )
     ),

    link = list(
      source = matriz$nos_rec,
      target = matriz$nos_desp,
      value =  matriz$ramo,
      color = matriz$cores_ramos
     #color =  "rgba(255,213,0,0.4)" # o pulo do gato! para deixar a cor translucida, é preciso usar rgba, e o último
                                     # parâmetro é a opacidade
      
      
    )
  ) %>% 
  layout(
    title = "",
    width = 700,
    height = 800,
    font = list(
      family = "Roboto Condensed Light, Source Sans Pro, Arial Narrow",
      size = 11,
      color = "#004a93"
    )
)

p
```

